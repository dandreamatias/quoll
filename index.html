<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>

</body>
<script>
    class Quoll {
        _statusMap = new Map();
        _httpError = (res) => console.error(`error ${res.status} on ${res.url}`)

        constructor() {
            if (Quoll._instance) {
                return Quoll._instance
            }
            Quoll._instance = this;
        }

        onStatus(statusCode, callBack) {
            this._statusMap.set(statusCode, callBack)
        }

        onHttpError(callBack) {
            this._httpError = callBack;
        }

        setHeader(header = {}) {
            this.headers = header
        }

        async get(url, obj = {}) {
            const hasParams = Object.keys(obj).length !== 0;
            const fullUrl = url + (hasParams ? `?${Object.keys(obj).map(key => key + '=' + obj[key]).join('&')}` : '');
            const res = await fetch(fullUrl);
            return this._handleResponse(res);
        }

        async post(url, body = {}) {
            const res = await fetch(url, {
                method: 'post',
                body: JSON.stringify(body),
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            return this._handleResponse(res);
        }

        _handleResponse(res) {
            console.log(res)
            if (!res.ok) {
                if (this._statusMap.has(res.status)) {
                    this._statusMap.get(res.status)(res);
                    return;
                }
                return this._httpError(res)
            }
            if (res.headers.get('content-type')) {
                console.log(res.headers.get('content-type').includes('application/json'))
            }
            return res['json']();
        }
    }
    const quoll = new Quoll();

    // quoll.onHttpError((res) => {
    //     console.error('generic http error')
    // });
    quoll.onStatus(404, (res) => {
        // redirect to login
        console.log(res.status)
    });

    // get with params
    quoll.get('https://jsonplaceholder.typicode.com/todos', {
        userId: 4,
        completed: true
    }).then(res => console.log(res));

    // post with body
    quoll.post('https://jsonplaceholder.typicode.com/todos', {
        user: 'Pippo',
        mail: 'qweqwe@gmail.com'
    }).then(res => console.log(res));

    // 404
    quoll.get('https://jsonplaceholder.typicode.com/qweqweqweqweqwe').then(res => console.log(res));
</script>

</html>